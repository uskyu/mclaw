# MClaw 开发总结（2026-02-21）

本文件用于同步当前阶段能力与限制，面向开发与联调。

## 当前状态

- 项目已进入「可上线内测」阶段：聊天主链路、服务器管理链路、部署链路可用。
- App 品牌已统一为 `MClaw`（含应用内 Logo 与 Android 启动图标）。
- 连接形态明确：`SSH 隧道` 与 `直连 WS/WSS` 二选一（手动选择模式）。

## 已完成里程碑

### M1：基础通信

- SSH 隧道连接（本地端口转发到远端 Gateway）。
- Gateway WebSocket 握手与请求响应。
- 聊天消息发送、历史拉取与会话列表。

### M2：会话与状态管理

- 会话切换、会话标题/本地备注。
- 按服务器恢复上次会话。
- 错误与连接状态可视化。

### M3：输入与渲染体验

- 流式输出可见且自动跟随到底部。
- 流式阶段使用纯文本渲染，完成后切回 Markdown，减少抖动。
- Markdown 表格可横向滚动；普通文本限制在气泡宽度内。
- 图片附件发送（相机/相册）；文件入口保留并标注开发中。

### M4：运维与直连部署

- Gateway 配置自动检测与自动修复。
- 一键部署直连（支持可选 WSS/Caddy，文案已标注推荐）。
- 支持重启 Gateway、清理远程历史。

### M5：Android 后台与通知

- 首次引导通知/后台权限说明与请求。
- 支持 Android 前台服务保活（后台运行）。
- AI 长任务完成后可在后台触发本地通知。
- 设置页新增通知帮助说明（权限要求）。

### M6：国际化与设置重构

- 语言策略：默认跟随系统语言（中/英），用户可手动切换并持久化。
- 设置页重构：去除重复深色模式入口、危险区；补充隐私/帮助/关于。
- 关于弹窗支持项目地址展示、复制链接、外部跳转。

## 关键技术结论

- OpenClaw 流式完成信号不仅有 `done`，还需兼容 `agent lifecycle end`。
- `sessions.patch` / `sessions.delete` 需要 `operator.admin` scope。
- 若无设备身份且未开启 `allowInsecureAuth`，可能缺失 `operator.write`。

## 当前限制

- 附件发送目前仅支持图片类型。
- 历史图片缩略图依赖本地路径，跨设备无法完整复原。
- 上下文百分比无实时接口，仅在状态查询时更新（UI 已提示说明）。
- 直连模式暂不支持“失败自动回退 SSH 隧道”。

## 下一步建议

1. 迁移 Markdown 依赖到 `flutter_markdown_plus`。
2. 增加弱网场景重连/恢复与直连失败自动兜底策略。
3. 在服务器编辑页开放 `remoteHost` 手动配置，提升 Docker 异构部署兼容性。
